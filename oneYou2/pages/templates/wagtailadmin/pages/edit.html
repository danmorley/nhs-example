{% extends "wagtailadmin/pages/edit.html" %}
{% load wagtailadmin_tags %}
{% load i18n %}
{% load l10n %}
{% block titletag %}{% blocktrans with title=page.get_admin_display_title page_type=content_type.model_class.get_verbose_name %}Editing {{ page_type }}: {{ title }}{% endblocktrans %}{% endblock %}
{% block bodyclass %}page-editor {% if page.live %}page-is-live{% endif %} model-{{ content_type.model }} {% if page.locked %}page-locked{% endif %}{% endblock %}

{% block extra_css %}
    {{ block.super }}
    {% include "wagtailadmin/pages/_editor_css.html" %}
    {{ edit_handler.form.media.css }}
    <style>
        .popup-cover {
            background-color: rgba(0, 0, 0, 0.4);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 150;
            width: 100%;
            height: 100vh;
            display: none;
        }

        .popup {
            background-color: #FFFFFF;
            width: 50%;
            margin-left: auto;
            margin-right: auto;
            padding: 30px 20px;
            margin-top: 20vh;
            border-radius: 10px;
        }
    </style>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    {% include "wagtailadmin/pages/_editor_js.html" %}

    {% comment %}
        Additional js from widgets media. Allows for custom widgets in admin panel.
    {% endcomment %}
    {{ edit_handler.form.media.js }}

    {% comment %}
        Additional HTML code that edit handlers define through 'html_declarations'. (Technically this isn't Javascript, but it will generally be data that exists for Javascript to work with...)
    {% endcomment %}
    {{ edit_handler.html_declarations }}

    <script>
        $(function () {
            /* Make user confirm before leaving the editor if there are unsaved changes */
            {% trans "This page has unsaved changes." as confirmation_message %}
            enableDirtyFormCheck(
                '#page-edit-form',
                {
                    confirmationMessage: '{{ confirmation_message|escapejs }}',

                    {% if has_unsaved_changes %}
                        alwaysDirty: true,
                    {% endif %}
                }
            );
        });
    </script>

    <script type="text/javascript" charset="utf-8">
        (function ($) {
            function startPopUpToggleWatcher() {
                $('button[name="action-publish"]').attr('id', 'release-picker-toggle');

                $('#release-picker-toggle').click(function (e) {
                    e.preventDefault();
                    $('.popup-cover').show();
                })
            }

            function startCancelWatcher(popUp) {
                popUp.append('<button id="cancel-btn" class="button no">Close</button>');
                $('#cancel-btn').click(function (e) {
                    e.preventDefault();
                    $('.popup-cover').hide();
                })
            }

            function setUpReleaseSelectorPopUp() {
                var releasePicker = $('#id_release').closest('.object.model_choice_field');
                releasePicker.wrap('<div class="popup-cover"><div class="popup"></div></div>');
                var releasePopUp = releasePicker.parent();
                $('button[name="action-publish"]').clone().appendTo(releasePopUp);
                releasePopUp.find('button[name="action-publish"]').attr('id', 'publish-page');
                startCancelWatcher(releasePopUp)
            }

            function init() {
                startPopUpToggleWatcher();

                setUpReleaseSelectorPopUp();
            }

            $(document).on('page:load', init);
            $(init)
        })(jQuery)
    </script>
{% endblock %}

